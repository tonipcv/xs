generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

   model User {
  id                   String             @id @default(cuid())
  name                 String?
  email                String             @unique
  emailVerified        DateTime?
  image                String?
  password             String?
  resetToken           String?            @unique
  resetTokenExpiry     DateTime?
  verificationToken    String?            @unique
  language             String?
  region               String             @default("OTHER")
  stripeCustomerId     String?            @unique
  tokensUsedThisMonth  Int                @default(0)
  freeTokensLimit      Int                @default(100000)
  totalTokensUsed      Int                @default(0)
  lastTokenReset       DateTime           @default(now())
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  phone                String?
  passwordResetToken   String?            @map("password_reset_token")
  passwordResetExpires DateTime?          @map("password_reset_expires")
  emailOtpCode         String?
  emailOtpExpires      DateTime?
  twoFactorEnabled     Boolean            @default(false)
  totpSecret           String?
  twoFactorVerifiedAt  DateTime?
  twoFactorBackupCodes String?
  
  // üéØ XASE PRICING: Entitlements baseados em plano
  planTier             String             @default("sandbox")  // sandbox|team|business|enterprise|enterprise_plus
  useCasesIncluded     Int                @default(1)          // N√∫mero de use cases regulados permitidos
  retentionYears       Float              @default(0.08)       // 0.08 = 30 dias (sandbox), 2, 5, 7, etc
  
  // üéØ XASE CORE: Link opcional para Tenant
  tenantId             String?            // Acesso ao console Xase
  xaseRole             XaseRole?          // Papel no Xase (OWNER, ADMIN, VIEWER)
  
  accounts             Account[]
  sessions             Session[]
  subscriptions        Subscription[]
  tenant               Tenant?            @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
   }

   model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

     @@unique([provider, providerAccountId])
   }

   model Session {
     id           String   @id @default(cuid())
     sessionToken String   @unique
     userId       String
     expires      DateTime
     user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   }

   model VerificationToken {
     identifier String
     token      String   @unique
     expires    DateTime

     @@unique([identifier, token])
   }

    model Subscription {
  id                 String   @id @default(cuid())
  userId             String
  priceId            String
  status             String
  stripeId           String   @unique
     currentPeriodStart DateTime
     currentPeriodEnd   DateTime
     cancelAtPeriodEnd  Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id])
   }

 

 

 

 

 

 

 

 

 

 

 

 

 

 

// ============================================
// üéØ XASE CORE - IMMUTABLE DECISION LEDGER
// ============================================
// M√≥dulo de evid√™ncia forense para decis√µes de IA
// Coexiste com o sistema existente sem conflitos

// üè¢ TENANT - Empresas clientes do Xase Core
model Tenant {
  id              String           @id @default(cuid())
  name            String
  email           String           @unique
  companyName     String?
  industry        String?
  website         String?
  
  // Status e billing
  status          TenantStatus     @default(ACTIVE)
  plan            String           @default("free")
  
  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Rela√ß√µes
  users             User[]             // Usu√°rios com acesso a este tenant
  apiKeys           ApiKey[]
  policies          Policy[]
  decisionRecords   DecisionRecord[]
  evidenceBundles   EvidenceBundle[]
  evidenceSnapshots EvidenceSnapshot[]
  interventions     HumanIntervention[]
  modelCards        ModelCard[]
  driftRecords      DriftRecord[]
  alerts            Alert[]
  metricsSnapshots  MetricsSnapshot[]
  alertRules        AlertRule[]
  
  @@map("xase_tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  
  @@map("xase_tenant_status")
}

// üë§ Pap√©is de usu√°rios no Xase Core
enum XaseRole {
  OWNER    // Dono do tenant, acesso total
  ADMIN    // Administrador, pode gerenciar usu√°rios e ver todas as provas
  VIEWER   // Visualizador, apenas l√™ provas
  
  @@map("xase_roles")
}

// üìã POLICY - Versionamento de pol√≠ticas de decis√£o
model Policy {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  
  // Identifica√ß√£o da pol√≠tica
  policyId        String    @map("policy_id") // Ex: "credit_policy", "fraud_detection"
  version         String    // Ex: "v1", "2025-01-15", "1.2.3"
  
  // Documento da pol√≠tica
  document        String    @db.Text // JSON ou texto completo da pol√≠tica
  documentHash    String    @map("document_hash") // SHA-256 do documento
  
  // Metadata
  name            String?   // Nome amig√°vel
  description     String?   @db.Text
  
  // Status
  isActive        Boolean   @default(true) @map("is_active")
  activatedAt     DateTime  @default(now()) @map("activated_at")
  deactivatedAt   DateTime? @map("deactivated_at")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, policyId, version])
  @@index([tenantId])
  @@index([policyId])
  @@index([isActive])
  @@map("xase_policies")
}

// üîë API KEY - Autentica√ß√£o para ingest√£o de decis√µes
model ApiKey {
  id          String    @id @default(cuid())
  tenantId    String
  name        String    // Ex: "Production API", "Development"
  keyHash     String    @unique // bcrypt hash da chave
  keyPrefix   String    // Primeiros 8 chars para identifica√ß√£o
  
  // Permiss√µes e limites
  isActive    Boolean   @default(true)
  permissions String    @default("ingest,verify") // Comma-separated: ingest,export,verify
  rateLimit   Int       @default(1000) // requests por hora
  
  // Metadata
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Rela√ß√µes
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([keyHash])
  @@map("xase_api_keys")
}

// üìú DECISION RECORD - Ledger imut√°vel de decis√µes de IA
model DecisionRecord {
  id              String    @id @default(cuid())
  tenantId        String
  
  // Identifica√ß√£o da decis√£o
  transactionId   String    // ID p√∫blico para recibo
  policyId        String?   // ID da pol√≠tica/modelo usado
  policyVersion   String?   // Vers√£o da pol√≠tica
  policyHash      String?   @map("policy_hash") // Hash da pol√≠tica no momento da decis√£o
  
  // Metadata do modelo de IA
  modelId         String?   @map("model_id") // Ex: "credit_model", "fraud_detector"
  modelVersion    String?   @map("model_version") // Ex: "2025-01-15", "v2.1"
  modelHash       String?   @map("model_hash") // Hash dos pesos/artefatos do modelo
  featureSchemaHash String? @map("feature_schema_hash") // Hash do schema de features usado
  explanationJson String?   @db.Text @map("explanation_json") // SHAP, LIME, ou explica√ß√£o custom (JSON)
  
  // Hashes criptogr√°ficos (SHA-256)
  inputHash       String    // Hash do input da decis√£o
  outputHash      String    // Hash do output/resultado
  contextHash     String?   // Hash do contexto adicional
  recordHash      String    // Hash encadeado (prev + current)
  previousHash    String?   // Hash do record anterior (chain)
  
  // Metadata da decis√£o
  decisionType    DecisionType?   // CLAIM | UNDERWRITING | FRAUD | PRICING | OTHER
  confidence      Float?    // Confian√ßa da IA (0-1)
  processingTime  Int?      // Tempo de processamento em ms
  
  // Payload opcional (se cliente quiser armazenar)
  inputPayload    String?   @db.Text // JSON stringificado
  outputPayload   String?   @db.Text // JSON stringificado
  contextPayload  String?   @db.Text // JSON stringificado
  
  // Storage externo (S3/R2)
  storageUrl      String?   // URL do payload completo em storage
  
  // Verifica√ß√£o de integridade
  isVerified      Boolean   @default(true)
  verifiedAt      DateTime  @default(now())
  
  // Human-in-the-Loop (campos derivados para facilitar queries)
  hasHumanIntervention Boolean @default(false) @map("hasHumanIntervention")
  finalDecisionSource  String  @default("AI") @map("finalDecisionSource") // AI, HUMAN_APPROVED, HUMAN_REJECTED, HUMAN_OVERRIDE
  
  // Reproducibility (Insurance Extension - Sprint 1)
  externalDataSnapshotId   String? @map("external_data_snapshot_id")
  businessRulesSnapshotId  String? @map("business_rules_snapshot_id")
  environmentSnapshotId    String? @map("environment_snapshot_id")
  featureVectorSnapshotId  String? @map("feature_vector_snapshot_id")
  dataTimestamp            DateTime? @map("data_timestamp") // quando dados externos foram coletados
  
  // Timestamps
  timestamp       DateTime  @default(now())
  createdAt       DateTime  @default(now())
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bundles         EvidenceBundle[]
  interventions   HumanIntervention[]
  insuranceDecision InsuranceDecision?
  
  @@unique([tenantId, recordHash])
  @@unique([tenantId, transactionId])
  @@index([tenantId])
  @@index([transactionId])
  @@index([timestamp])
  @@index([policyId])
  @@index([recordHash])
  @@map("xase_decision_records")
}

// üîê CHECKPOINT RECORD - REMOVED
// Checkpoints were removed to simplify the system.
// Legal guarantees are maintained through:
// - Record chain (previousHash ‚Üí recordHash)
// - Evidence bundles (bundleManifestHash + verify.js)
// - Audit logs (immutable trail)
// - KMS signing service (available for bundle signing)
// See: docs/LEGAL_GUARANTEES_WITHOUT_CHECKPOINTS.md

// üìã AUDIT LOG - Trilha imut√°vel de a√ß√µes administrativas
model AuditLog {
  id            String    @id @default(cuid())
  tenantId      String?
  userId        String?
  
  // A√ß√£o realizada
  action        String    // Ex: "KEY_ROTATED", "EXPORT_CREATED", "PAYLOAD_ACCESSED"
  resourceType  String    // Ex: "API_KEY", "DECISION_RECORD", "CHECKPOINT"
  resourceId    String?   // ID do recurso afetado
  
  // Contexto
  metadata      String?   @db.Text // JSON com detalhes adicionais
  ipAddress     String?
  userAgent     String?
  
  // Resultado
  status        String    @default("SUCCESS") // SUCCESS, FAILED, DENIED
  errorMessage  String?
  
  // Timestamps (IMUT√ÅVEL via trigger)
  timestamp     DateTime  @default(now())
  
  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("xase_audit_logs")
}

// üì¶ EVIDENCE BUNDLE - Bundles exportados e armazenados
// IMUT√ÅVEL: EvidenceBundle √© somente-cria√ß√£o (create-only).
// Nunca √© atualizado ou deletado ap√≥s criado. Acessos s√£o registrados em AuditLog.
model EvidenceBundle {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  recordId        String?   @map("record_id") // FK para DecisionRecord (opcional para bundles multi-record)
  
  // Identifica√ß√£o
  bundleId        String    @unique @map("bundle_id") // ID p√∫blico do bundle
  transactionId   String?   @map("transaction_id") // C√≥pia do transactionId do record (opcional)
  
  // Status do bundle (para gera√ß√£o ass√≠ncrona)
  status          String    @default("PENDING") // PENDING, PROCESSING, READY, FAILED
  
  // Compliance metadata
  purpose         String?   // AUDIT, COMPLIANCE, LEGAL, INVESTIGATION, BACKUP, OTHER
  description     String?   @db.Text // Descri√ß√£o do prop√≥sito
  recordCount     Int       @default(0) @map("record_count") // N√∫mero de records no bundle
  
  // Filtros aplicados
  dateFrom        DateTime? @map("date_from") // In√≠cio do per√≠odo
  dateTo          DateTime? @map("date_to") // Fim do per√≠odo
  
  // Armazenamento
  storageUrl      String?   @map("storage_url") // S3/R2 URL do ZIP
  storageKey      String?   @map("storage_key") // Chave no bucket
  bundleHash      String?   @map("bundle_hash") // SHA-256 do ZIP completo
  bundleSize      Int?      @map("bundle_size") // Tamanho em bytes
  
  // Metadata
  format          String    @default("zip") // zip, tar.gz
  includesPdf     Boolean   @default(false) @map("includes_pdf")
  includesPayloads Boolean  @default(true) @map("includes_payloads")
  
  // Insurance Extension - Sprint 2
  legalFormat          String @default("standard") @map("legal_format") // standard, ediscovery, uk_eidas, us_esign
  pdfReportUrl         String? @map("pdf_report_url")
  pdfReportHash        String? @map("pdf_report_hash")
  pdfReportLogicalHash String? @map("pdf_report_logical_hash")
  chainOfCustodyReportJson String? @db.Text @map("chain_of_custody_report_json")
  bundleManifestHash   String? @map("bundle_manifest_hash")
  
  // Blockchain (opcional, futuro)
  merkleRoot           String? @map("merkle_root")
  blockchainNetwork    String? @map("blockchain_network")
  blockchainTxHash     String? @map("blockchain_tx_hash")
  blockchainAnchorAt   DateTime? @map("blockchain_anchor_at")
  
  // Reten√ß√£o e compliance
  retentionUntil  DateTime? @map("retention_until") // Data de expira√ß√£o (WORM/legal hold)
  expiresAt       DateTime? @map("expires_at") // Data de expira√ß√£o do download
  legalHold       Boolean   @default(false) @map("legal_hold")
  
  // Auditoria
  createdBy       String    @map("created_by") // Email/ID do usu√°rio que criou
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at") // Quando ficou READY
  accessedAt      DateTime? @map("accessed_at") // √öltima vez que foi baixado
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  record          DecisionRecord? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([recordId])
  @@index([transactionId])
  @@index([bundleId])
  @@index([status])
  @@index([createdBy])
  @@map("xase_evidence_bundles")
}

// üë§ HUMAN INTERVENTION - Registro de interven√ß√µes humanas em decis√µes de IA
// IMUT√ÅVEL: Nunca √© atualizado ou deletado ap√≥s criado (via trigger SQL)
enum InterventionAction {
  REVIEW_REQUESTED  // Decis√£o marcada para revis√£o humana
  APPROVED          // Humano aprovou decis√£o da IA
  REJECTED          // Humano rejeitou decis√£o da IA
  OVERRIDE          // Humano alterou o resultado da IA
  ESCALATED         // Decis√£o escalada para n√≠vel superior
  
  @@map("xase_intervention_action")
}

model HumanIntervention {
  id              String    @id @default(cuid())
  tenantId        String
  recordId        String    @map("record_id")
  
  // A√ß√£o e ator
  action          InterventionAction
  actorUserId     String?   @map("actorUserId")  // ID do usu√°rio que interveio
  actorName       String?   @map("actorName")    // Nome do ator (snapshot)
  actorEmail      String?   @map("actorEmail")   // Email do ator (snapshot)
  actorRole       String?   @map("actorRole")    // Papel do ator no momento (snapshot)
  
  // Contexto da interven√ß√£o
  reason          String?   // Justificativa da interven√ß√£o
  notes           String?   @db.Text // Notas adicionais
  metadata        String?   @db.Text // JSON com contexto adicional
  
  // Resultado (para OVERRIDE)
  newOutcome      String?   @db.Text @map("newOutcome")      // JSON com novo resultado (se OVERRIDE)
  previousOutcome String?   @db.Text @map("previousOutcome") // JSON com resultado anterior da IA
  
  // Rastreabilidade
  ipAddress       String?   @map("ipAddress")
  userAgent       String?   @map("userAgent")
  timestamp       DateTime  @default(now())
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  record          DecisionRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([recordId])
  @@index([action])
  @@index([actorUserId])
  @@index([timestamp])
  @@map("xase_human_interventions")
}

// üìä MODEL CARD - Ficha t√©cnica dos modelos de IA
model ModelCard {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  
  // Identifica√ß√£o do modelo
  modelId         String    @map("model_id")
  modelVersion    String    @map("model_version")
  modelHash       String    @map("model_hash") // SHA-256 dos pesos/artefatos
  
  // Metadata do modelo
  modelName       String?   @map("model_name")
  modelType       String?   @map("model_type") // Ex: "random_forest", "neural_network"
  framework       String?   // Ex: "scikit-learn", "tensorflow", "pytorch"
  description     String?   @db.Text
  
  // Treinamento
  trainingDate    DateTime? @map("training_date")
  datasetHash     String?   @map("dataset_hash")
  datasetSize     Int?      @map("dataset_size")
  trainingDuration Int?     @map("training_duration_seconds")
  
  // Performance Metrics (JSON)
  performanceMetrics String? @db.Text @map("performance_metrics")
  fairnessMetrics    String? @db.Text @map("fairness_metrics")
  validationMetrics  String? @db.Text @map("validation_metrics")
  
  // Uso pretendido
  intendedUse            String? @db.Text @map("intended_use")
  limitations            String? @db.Text
  ethicalConsiderations  String? @db.Text @map("ethical_considerations")
  
  // Feature Schema
  featureSchemaHash String? @map("feature_schema_hash")
  featureSchema     String? @db.Text @map("feature_schema")
  featureImportance String? @db.Text @map("feature_importance")
  
  // Status
  isActive      Boolean   @default(true) @map("is_active")
  deployedAt    DateTime? @map("deployed_at")
  deprecatedAt  DateTime? @map("deprecated_at")
  
  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Rela√ß√µes
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, modelId, modelVersion])
  @@index([tenantId])
  @@index([modelId])
  @@index([modelHash])
  @@index([isActive])
  @@map("xase_model_cards")
}

// üìà DRIFT DETECTION - Monitoramento de drift de modelos
model DriftRecord {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  modelId         String    @map("model_id")
  modelVersion    String    @map("model_version")
  
  // Tipo de drift
  driftType       String    @map("drift_type") // DATA_DRIFT, CONCEPT_DRIFT, PREDICTION_DRIFT
  severity        String    // LOW, MEDIUM, HIGH, CRITICAL
  
  // M√©tricas de drift
  driftScore      Float     @map("drift_score")
  threshold       Float
  metricName      String?   @map("metric_name")
  
  // Detalhes
  affectedFeatures      String?   @db.Text @map("affected_features")
  baselinePeriodStart   DateTime? @map("baseline_period_start")
  baselinePeriodEnd     DateTime? @map("baseline_period_end")
  detectionPeriodStart  DateTime? @map("detection_period_start")
  detectionPeriodEnd    DateTime? @map("detection_period_end")
  
  // Estat√≠sticas
  baselineStats   String?   @db.Text @map("baseline_stats")
  currentStats    String?   @db.Text @map("current_stats")
  sampleSize      Int?      @map("sample_size")
  
  // A√ß√µes
  alertSent       Boolean   @default(false) @map("alert_sent")
  alertSentAt     DateTime? @map("alert_sent_at")
  resolved        Boolean   @default(false)
  resolvedAt      DateTime? @map("resolved_at")
  resolutionNotes String?   @db.Text @map("resolution_notes")
  
  // Timestamps
  detectedAt      DateTime  @default(now()) @map("detected_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([modelId])
  @@index([severity])
  @@index([detectedAt])
  @@index([resolved])
  @@map("xase_drift_records")
}

// üîî ALERTS - Sistema de alertas proativos
model Alert {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  
  // Tipo e severidade
  alertType       String    @map("alert_type")
  severity        String
  status          String    @default("OPEN")
  
  // Contexto
  title           String
  message         String    @db.Text
  resourceType    String?   @map("resource_type")
  resourceId      String?   @map("resource_id")
  
  // M√©tricas relacionadas
  metricName      String?   @map("metric_name")
  metricValue     Float?    @map("metric_value")
  thresholdValue  Float?    @map("threshold_value")
  
  // Detalhes
  details         String?   @db.Text
  recommendations String?   @db.Text
  
  // Notifica√ß√µes
  notificationSent     Boolean   @default(false) @map("notification_sent")
  notificationSentAt   DateTime? @map("notification_sent_at")
  notificationChannels String?   @db.Text @map("notification_channels")
  
  // Resolu√ß√£o
  acknowledgedBy  String?   @map("acknowledged_by")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  resolvedBy      String?   @map("resolved_by")
  resolvedAt      DateTime? @map("resolved_at")
  resolutionNotes String?   @db.Text @map("resolution_notes")
  
  // Timestamps
  triggeredAt     DateTime  @default(now()) @map("triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([triggeredAt])
  @@map("xase_alerts")
}

// üìä METRICS SNAPSHOT - Snapshots peri√≥dicos de m√©tricas
model MetricsSnapshot {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  
  // Per√≠odo
  snapshotType    String    @map("snapshot_type")
  periodStart     DateTime  @map("period_start")
  periodEnd       DateTime  @map("period_end")
  
  // M√©tricas agregadas
  totalDecisions      Int   @default(0) @map("total_decisions")
  aiDecisions         Int   @default(0) @map("ai_decisions")
  humanInterventions  Int   @default(0) @map("human_interventions")
  overrideCount       Int   @default(0) @map("override_count")
  approvalCount       Int   @default(0) @map("approval_count")
  rejectionCount      Int   @default(0) @map("rejection_count")
  
  // Taxas calculadas
  overrideRate      Float?  @map("override_rate")
  interventionRate  Float?  @map("intervention_rate")
  approvalRate      Float?  @map("approval_rate")
  
  // Performance
  avgConfidence         Float?  @map("avg_confidence")
  avgProcessingTimeMs   Float?  @map("avg_processing_time_ms")
  p95ProcessingTimeMs   Float?  @map("p95_processing_time_ms")
  p99ProcessingTimeMs   Float?  @map("p99_processing_time_ms")
  
  // Por modelo (JSON)
  metricsByModel        String? @db.Text @map("metrics_by_model")
  metricsByPolicy       String? @db.Text @map("metrics_by_policy")
  metricsByDecisionType String? @db.Text @map("metrics_by_decision_type")
  
  // Top motivos de override
  topOverrideReasons    String? @db.Text @map("top_override_reasons")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, snapshotType, periodStart])
  @@index([tenantId])
  @@index([periodStart, periodEnd])
  @@index([snapshotType])
  @@map("xase_metrics_snapshots")
}

// üéØ ALERT RULES - Regras configur√°veis de alertas
model AlertRule {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  
  // Identifica√ß√£o
  ruleName        String    @map("rule_name")
  ruleType        String    @map("rule_type")
  description     String?   @db.Text
  
  // Condi√ß√µes
  metricName          String  @map("metric_name")
  operator            String
  thresholdValue      Float   @map("threshold_value")
  timeWindowMinutes   Int?    @map("time_window_minutes")
  
  // Filtros
  modelId         String?   @map("model_id")
  policyId        String?   @map("policy_id")
  decisionType    String?   @map("decision_type")
  
  // A√ß√µes
  severity                String  @map("severity")
  notificationChannels    String? @db.Text @map("notification_channels")
  notificationTemplate    String? @db.Text @map("notification_template")
  
  // Status
  isActive            Boolean   @default(true) @map("is_active")
  lastTriggeredAt     DateTime? @map("last_triggered_at")
  triggerCount        Int       @default(0) @map("trigger_count")
  
  // Cooldown
  cooldownMinutes     Int       @default(60) @map("cooldown_minutes")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Rela√ß√µes
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([isActive])
  @@index([metricName])
  @@map("xase_alert_rules")
}

// ============================================================================
// üè• INSURANCE EXTENSION - Sprint 1
// ============================================================================

// üî¨ EVIDENCE SNAPSHOT - Snapshots imut√°veis para reproducibility
model EvidenceSnapshot {
  id          String @id @default(cuid())
  tenantId    String @map("tenant_id")
  
  // Tipo de snapshot
  type        SnapshotType
  
  // Storage (S3/MinIO)
  storageUrl  String @map("storage_url")
  storageKey  String @map("storage_key")
  payloadHash String @map("payload_hash") // SHA-256 do JSON canonical
  payloadSize Int?   @map("payload_size")
  
  // Metadata
  sourceMeta  String? @db.Text @map("source_meta") // JSON: APIs consultadas, vers√µes, etc.
  capturedAt  DateTime @default(now()) @map("captured_at")
  
  // Compression
  compressed  Boolean @default(false)
  compressionAlgo String? @map("compression_algo") // gzip, brotli
  
  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([type])
  @@index([capturedAt])
  @@index([payloadHash]) // para deduplica√ß√£o
  @@map("xase_evidence_snapshots")
}

enum SnapshotType {
  EXTERNAL_DATA
  BUSINESS_RULES
  ENVIRONMENT
  FEATURE_VECTOR
  
  @@map("xase_snapshot_type")
}

// üè• INSURANCE DECISION - Overlay com campos espec√≠ficos de insurance
model InsuranceDecision {
  id              String @id @default(cuid())
  recordId        String @unique @map("record_id") // FK para DecisionRecord
  
  // Claim fields
  claimNumber     String? @map("claim_number")
  claimType       InsuranceClaimType? @map("claim_type")
  claimAmount     Decimal? @map("claim_amount") @db.Decimal(15, 2)
  claimDate       DateTime? @map("claim_date")
  
  // Policy fields
  policyNumber    String? @map("policy_number")
  policyHolderIdHash String? @map("policy_holder_id_hash") // SHA-256(CPF/SSN)
  insuredAmount   Decimal? @map("insured_amount") @db.Decimal(15, 2)
  
  // Underwriting fields
  riskScore       Float? @map("risk_score")
  underwritingDecision String? @map("underwriting_decision") // APPROVED, DECLINED, REFERRED
  premiumCalculated    Decimal? @map("premium_calculated") @db.Decimal(15, 2)
  coverageOfferedJson  String? @db.Text @map("coverage_offered_json")
  
  // Outcome (gen√©rico para narrativas jur√≠dicas)
  decisionOutcome       String? @map("decision_outcome")
  decisionOutcomeReason String? @map("decision_outcome_reason")
  
  // Decision Impact (reguladores)
  decisionImpactFinancial      Decimal? @map("decision_impact_financial") @db.Decimal(15, 2)
  decisionImpactConsumerImpact DecisionConsumerImpact? @map("decision_impact_consumer")
  decisionImpactAppealable     Boolean? @map("decision_impact_appealable")
  
  // Regulatory
  regulatoryCaseId String? @map("regulatory_case_id")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  record DecisionRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  @@index([claimNumber])
  @@index([policyNumber])
  @@index([claimType])
  @@index([claimDate])
  @@map("xase_insurance_decisions")
}

enum InsuranceClaimType {
  AUTO
  HEALTH
  LIFE
  PROPERTY
  LIABILITY
  TRAVEL
  
  @@map("xase_insurance_claim_type")
}

enum DecisionConsumerImpact {
  LOW
  MEDIUM
  HIGH
  
  @@map("xase_decision_consumer_impact")
}

// Tipo de decis√£o padronizado (evita ambiguidade)
enum DecisionType {
  CLAIM
  UNDERWRITING
  FRAUD
  PRICING
  OTHER

  @@map("xase_decision_type")
}
