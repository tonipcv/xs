#!/usr/bin/env node
/*
 * Xase - Prisma Migration Runner
 *
 * Runs Prisma migrations directly via Node, choosing the right command per env:
 * - development/staging: `prisma migrate dev --name <name>` (if name provided)
 * - production: `prisma migrate deploy`
 *
 * Usage:
 *   node scripts/run-prisma-migrate.js [migration-name]
 *
 * Env:
 *   NODE_ENV=production -> uses `deploy`
 *   MIGRATION_NAME can be used instead of argv
 */

const { spawnSync } = require('child_process');

function run(cmd, args, opts = {}) {
  const res = spawnSync(cmd, args, { stdio: 'inherit', shell: process.platform === 'win32', ...opts });
  if (res.error) throw res.error;
  if (res.status !== 0) process.exit(res.status || 1);
}

function main() {
  const isProd = process.env.NODE_ENV === 'production';
  const providedName = process.argv[2] || process.env.MIGRATION_NAME || '';

  if (isProd) {
    console.log('üöÄ Running Prisma migration (deploy) for production...');
    run('npx', ['prisma', 'migrate', 'deploy']);
  } else {
    const args = ['prisma', 'migrate', 'dev'];
    if (providedName) {
      args.push('--name', providedName);
    } else {
      console.log('‚ÑπÔ∏è No migration name provided. A default name will be generated by Prisma.');
    }
    console.log('üõ†  Running Prisma migration (dev)...');
    run('npx', args);
  }

  console.log('‚úÖ Prisma migration completed successfully.');
}

main();
